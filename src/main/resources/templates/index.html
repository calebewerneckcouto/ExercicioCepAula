<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Navegação Mobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
        }
        
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        /* Painel de busca compacto */
        .search-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .search-header {
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-content {
            padding: 15px;
        }
        
        .quick-search {
            position: relative;
            margin-bottom: 10px;
        }
        
        .quick-search input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
        }
        
        .quick-search .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 18px;
        }
        
        .location-type {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .location-type button {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .location-type button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .selected-locations {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .location-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .location-item .icon {
            font-size: 20px;
            min-width: 25px;
        }
        
        .location-item .text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .location-item .clear {
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
        }
        
        .search-results {
            max-height: 40vh;
            overflow-y: auto;
        }
        
        .result-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .result-item:hover {
            background: #f8f9fa;
        }
        
        .result-item .name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .result-item .address {
            font-size: 13px;
            color: #666;
        }
        
        /* Painel de navegação */
        .nav-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            padding: 15px;
            display: none;
        }
        
        .nav-panel.active {
            display: block;
        }
        
        .nav-instruction {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .nav-instruction .icon {
            font-size: 36px;
            color: #667eea;
            min-width: 40px;
        }
        
        .nav-instruction .text {
            flex: 1;
        }
        
        .nav-instruction .distance {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .nav-stats {
            display: flex;
            gap: 10px;
            justify-content: space-around;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .nav-stats .stat {
            text-align: center;
        }
        
        .nav-stats .value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        /* Controles flutuantes otimizados */
        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        .control-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 64px;
            height: 64px;
        }
        
        .control-btn.danger {
            background: #dc3545;
            color: white;
        }
        
        /* Toggle de busca */
        .search-toggle {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 999;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            color: #667eea;
        }
        
        /* Velocímetro */
        .speed-display {
            position: fixed;
            bottom: 20px;
            left: 15px;
            z-index: 1000;
            background: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
        }
        
        .speed-display.active {
            display: block;
        }
        
        .speed-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .speed-unit {
            font-size: 14px;
            color: #666;
        }
        
        /* Alerta de manobra */
        .maneuver-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
            max-width: 90%;
        }
        
        .maneuver-alert.show {
            display: block;
            animation: alertPulse 0.5s ease;
        }
        
        .maneuver-alert .icon {
            font-size: 64px;
            margin-bottom: 15px;
        }
        
        .maneuver-alert .text {
            font-size: 24px;
            font-weight: bold;
        }
        
        @keyframes alertPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        /* GPS Status */
        .gps-status {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 999;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 12px;
            font-weight: 600;
        }
        
        .gps-status.active {
            background: #28a745;
            color: white;
        }
        
        .gps-status.inactive {
            background: #dc3545;
            color: white;
        }
        
        /* Histórico compacto */
        .history-list {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .history-item:active {
            background: #e9ecef;
        }
        
        .history-item .name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .history-item .details {
            color: #666;
            font-size: 11px;
        }
        
        /* Botões de ação rápida */
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .quick-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-recalculate {
            background: #ff9800;
            color: white;
        }
        
        .btn-clear {
            background: #dc3545;
            color: white;
        }
        
        /* Animação de pulse para marcador */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(0, 123, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .loading i {
            font-size: 32px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Mapa (sempre visível) -->
    <div id="map"></div>
    
    <!-- GPS Status -->
    <div id="gpsStatus" class="gps-status inactive">
        <i class="fas fa-satellite-dish"></i> GPS OFF
    </div>
    
    <!-- Toggle de Busca -->
    <div class="search-toggle" onclick="toggleSearchPanel()">
        <i class="fas fa-search"></i>
    </div>
    
    <!-- Painel de Busca -->
    <div id="searchPanel" class="search-panel" style="display: none;">
        <div class="search-header">
            <h6 class="mb-0"><i class="fas fa-map-marker-alt"></i> Buscar Local</h6>
            <i class="fas fa-times" onclick="toggleSearchPanel()" style="cursor: pointer;"></i>
        </div>
        <div class="search-content">
            <!-- Busca Rápida -->
            <div class="quick-search">
                <input type="text" id="inputBusca" placeholder="Digite endereço, CEP ou coordenadas..." autocomplete="off">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <!-- Tipo de Localização -->
            <div class="location-type">
                <button id="btnOrigem" onclick="setLocationMode('origem')">
                    <i class="fas fa-circle"></i> Origem
                </button>
                <button id="btnDestino" onclick="setLocationMode('destino')">
                    <i class="fas fa-flag-checkered"></i> Destino
                </button>
            </div>
            
            <!-- Locais Selecionados -->
            <div class="selected-locations">
                <div class="location-item" id="origemDisplay">
                    <span class="icon">📍</span>
                    <span class="text" id="origemText">Nenhuma origem</span>
                    <i class="fas fa-times-circle clear" onclick="clearOrigem()" style="display: none;"></i>
                </div>
                <div class="location-item" id="destinoDisplay">
                    <span class="icon">🏁</span>
                    <span class="text" id="destinoText">Nenhum destino</span>
                    <i class="fas fa-times-circle clear" onclick="clearDestino()" style="display: none;"></i>
                </div>
            </div>
            
            <!-- Resultados da Busca -->
            <div id="searchResults" class="search-results"></div>
            
            <!-- Histórico -->
            <div th:if="${historico != null && !historico.empty}">
                <h6 class="mt-3 mb-2"><i class="fas fa-history"></i> Recentes</h6>
                <div class="history-list">
                    <div th:each="endereco : ${historico}" class="history-item" 
                         th:data-cep="${endereco.cep}" 
                         th:data-endereco="${endereco.logradouro} + ', ' + ${endereco.localidade}"
                         onclick="selectFromHistory(this)">
                        <div class="name" th:text="${endereco.logradouro}">Endereço</div>
                        <div class="details">
                            <span th:text="${endereco.localidade} + ' - ' + ${endereco.uf}">Cidade</span> • 
                            <span th:text="${endereco.cep}">CEP</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ações Rápidas -->
            <div class="quick-actions">
                <button class="btn-calculate" onclick="calcularRota()" id="btnCalcular" disabled>
                    <i class="fas fa-route"></i> Calcular
                </button>
                <button class="btn-clear" onclick="limparTudo()">
                    <i class="fas fa-trash"></i> Limpar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Painel de Navegação -->
    <div id="navPanel" class="nav-panel">
        <div class="nav-instruction">
            <div class="icon" id="navIcon">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="text">
                <div id="navText" style="font-size: 14px; font-weight: 600;">Iniciando navegação...</div>
            </div>
            <div class="distance" id="navDistance">--</div>
        </div>
        <div class="nav-stats">
            <div class="stat">
                <div class="value" id="etaTime">--:--</div>
                <div>Chegada</div>
            </div>
            <div class="stat">
                <div class="value" id="remainingDistance">--</div>
                <div>Distância</div>
            </div>
            <div class="stat">
                <div class="value" id="remainingTime">--</div>
                <div>Tempo</div>
            </div>
        </div>
    </div>
    
    <!-- Velocímetro -->
    <div id="speedDisplay" class="speed-display">
        <span class="speed-value" id="speedValue">0</span>
        <span class="speed-unit">km/h</span>
    </div>
    
    <!-- Alerta de Manobra -->
    <div id="maneuverAlert" class="maneuver-alert">
        <div class="icon" id="alertIcon">
            <i class="fas fa-arrow-right"></i>
        </div>
        <div class="text" id="alertText">Vire à direita</div>
    </div>
    
    <!-- Controles Flutuantes -->
    <div class="floating-controls">
        <button class="control-btn primary" id="btnNav" onclick="toggleNavigation()" title="Navegação">
            <i class="fas fa-play"></i>
        </button>
        <button class="control-btn" onclick="recalcularRota()" id="btnRecalc" title="Recalcular" style="display: none;">
            <i class="fas fa-redo"></i>
        </button>
        <button class="control-btn" onclick="centralizarUsuario()" title="Minha Posição">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button class="control-btn" onclick="iniciarGPS()" id="btnGPS" title="GPS">
            <i class="fas fa-satellite"></i>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script th:inline="javascript">
        // Variáveis globais
        var map;
        var userMarker = null;
        var originMarker = null;
        var destinationMarker = null;
        var routePolyline = null;
        var watchId = null;
        var isGPSActive = false;
        var isNavigating = false;
        var locationMode = 'origem'; // 'origem' ou 'destino'
        var origemData = null;
        var destinoData = null;
        var rotaData = /*[[${rota}]]*/ null;
        var currentPosition = null;
        var searchTimeout = null;

        // Inicialização
        window.onload = function() {
            inicializarMapa();
            configurarEventos();
            
            if (rotaData) {
                processarRota();
                mostrarBotaoRecalcular();
            }
            
            // Ativar GPS automaticamente
            setTimeout(() => iniciarGPS(), 1000);
        };

        function inicializarMapa() {
            map = L.map('map', {
                zoomControl: false
            }).setView([-15.7797, -47.9297], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            // Adicionar controle de zoom no canto inferior esquerdo
            L.control.zoom({
                position: 'bottomleft'
            }).addTo(map);
        }

        function configurarEventos() {
            const input = document.getElementById('inputBusca');
            
            input.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                if (e.target.value.length >= 3) {
                    searchTimeout = setTimeout(() => {
                        buscarLocal(e.target.value);
                    }, 500);
                } else {
                    document.getElementById('searchResults').innerHTML = '';
                }
            });
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    buscarLocal(e.target.value);
                }
            });
        }

        // GPS Functions
        function iniciarGPS() {
            if (!navigator.geolocation) {
                alert('GPS não disponível neste dispositivo');
                return;
            }

            if (isGPSActive) {
                // Desativar GPS
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                }
                isGPSActive = false;
                document.getElementById('gpsStatus').className = 'gps-status inactive';
                document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-satellite-dish"></i> GPS OFF';
                document.getElementById('speedDisplay').classList.remove('active');
            } else {
                // Ativar GPS
                watchId = navigator.geolocation.watchPosition(
                    atualizarPosicao,
                    erroGPS,
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
                
                isGPSActive = true;
                document.getElementById('gpsStatus').className = 'gps-status active';
                document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-satellite-dish"></i> GPS ON';
                document.getElementById('speedDisplay').classList.add('active');
            }
        }

        function atualizarPosicao(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const speed = (position.coords.speed || 0) * 3.6; // m/s para km/h
            
            currentPosition = { lat, lng };
            
            // Atualizar velocímetro
            document.getElementById('speedValue').textContent = Math.round(speed);
            
            // Atualizar marcador
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="width: 20px; height: 20px; background: #007bff; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 0 rgba(0, 123, 255, 0.4); animation: pulse 2s infinite;"></div>',
                        iconSize: [20, 20]
                    })
                }).addTo(map);
                
                map.setView([lat, lng], 16);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
            
            // Se estiver navegando, verificar progresso
            if (isNavigating && rotaData) {
                verificarProgresso(lat, lng);
            }
        }

        function erroGPS(error) {
            console.error('Erro GPS:', error);
            document.getElementById('gpsStatus').className = 'gps-status inactive';
            document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro GPS';
        }

        function centralizarUsuario() {
            if (currentPosition) {
                map.setView([currentPosition.lat, currentPosition.lng], 16);
            } else {
                alert('GPS não está ativo');
            }
        }

        // Search Functions
        function toggleSearchPanel() {
            const panel = document.getElementById('searchPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function setLocationMode(mode) {
            locationMode = mode;
            
            document.getElementById('btnOrigem').classList.remove('active');
            document.getElementById('btnDestino').classList.remove('active');
            
            if (mode === 'origem') {
                document.getElementById('btnOrigem').classList.add('active');
            } else {
                document.getElementById('btnDestino').classList.add('active');
            }
        }

        function buscarLocal(query) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query || query.length < 3) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i></div>';
            
            // Verificar se é coordenada
            if (/^-?\d+\.?\d*,\s*-?\d+\.?\d*$/.test(query)) {
                const [lat, lng] = query.split(',').map(s => parseFloat(s.trim()));
                mostrarResultadoCoordenada(lat, lng);
                return;
            }
            
            // Buscar no Nominatim
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=8`)
                .then(response => response.json())
                .then(data => {
                    mostrarResultados(data);
                })
                .catch(error => {
                    console.error('Erro na busca:', error);
                    resultsDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #dc3545;">Erro na busca</div>';
                });
        }

        function mostrarResultados(resultados) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (resultados.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">Nenhum resultado</div>';
                return;
            }
            
            let html = '';
            resultados.forEach(r => {
                html += `
                    <div class="result-item" onclick='selecionarLocal(${r.lat}, ${r.lon}, "${r.display_name.replace(/'/g, "\\'")}");'>
                        <div class="name">${r.display_name.split(',')[0]}</div>
                        <div class="address">${r.display_name}</div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        function mostrarResultadoCoordenada(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    const endereco = data.display_name || 'Localização';
                    selecionarLocal(lat, lng, endereco);
                })
                .catch(console.error);
        }

        function selecionarLocal(lat, lng, endereco) {
            const data = {
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                endereco: endereco
            };
            
            if (locationMode === 'origem') {
                origemData = data;
                document.getElementById('origemText').textContent = endereco.split(',')[0];
                document.querySelector('#origemDisplay .clear').style.display = 'block';
                
                if (originMarker) map.removeLayer(originMarker);
                originMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'origin-marker',
                        html: '<div style="width: 16px; height: 16px; background: #28a745; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>'
                    })
                }).addTo(map);
            } else {
                destinoData = data;
                document.getElementById('destinoText').textContent = endereco.split(',')[0];
                document.querySelector('#destinoDisplay .clear').style.display = 'block';
                
                if (destinationMarker) map.removeLayer(destinationMarker);
                destinationMarker = L.marker([lat, lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    })
                }).addTo(map);
            }
            
            map.setView([lat, lng], 15);
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('inputBusca').value = '';
            
            verificarBotaoCalcular();
        }

        function selectFromHistory(element) {
            const cep = element.getAttribute('data-cep');
            const endereco = element.getAttribute('data-endereco');
            
            // Buscar coordenadas do CEP
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${endereco}&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        selecionarLocal(data[0].lat, data[0].lon, endereco);
                    }
                })
                .catch(console.error);
        }

        function clearOrigem() {
            origemData = null;
            document.getElementById('origemText').textContent = 'Nenhuma origem';
            document.querySelector('#origemDisplay .clear').style.display = 'none';
            if (originMarker) {
                map.removeLayer(originMarker);
                originMarker = null;
            }
            verificarBotaoCalcular();
        }

        function clearDestino() {
            destinoData = null;
            document.getElementById('destinoText').textContent = 'Nenhum destino';
            document.querySelector('#destinoDisplay .clear').style.display = 'none';
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            verificarBotaoCalcular();
        }

        function limparTudo() {
            clearOrigem();
            clearDestino();
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('inputBusca').value = '';
            rotaData = null;
            esconderBotaoRecalcular();
        }

        function verificarBotaoCalcular() {
            const btn = document.getElementById('btnCalcular');
            if (origemData && destinoData) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        // Route Functions
        function calcularRota() {
            if (!origemData || !destinoData) {
                alert('Selecione origem e destino');
                return;
            }
            
            const btn = document.getElementById('btnCalcular');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
            
            // Usar OSRM para calcular rota
            const url = `https://router.project-osrm.org/route/v1/driving/${origemData.lng},${origemData.lat};${destinoData.lng},${destinoData.lat}?overview=full&steps=true&geometries=polyline`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'Ok' && data.routes.length > 0) {
                        rotaData = processarRotaOSRM(data.routes[0]);
                        desenharRota(rotaData);
                        toggleSearchPanel();
                        mostrarBotaoRecalcular();
                        
                        // Mostrar mensagem de sucesso
                        alert(`Rota calculada!\nDistância: ${(rotaData.distance / 1000).toFixed(1)} km\nTempo: ${Math.round(rotaData.duration / 60)} min`);
                    } else {
                        alert('Não foi possível calcular a rota');
                    }
                    
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-route"></i> Calcular';
                })
                .catch(error => {
                    console.error('Erro ao calcular rota:', error);
                    alert('Erro ao calcular rota. Tente novamente.');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-route"></i> Calcular';
                });
        }

        function recalcularRota() {
            if (!currentPosition) {
                alert('GPS não está ativo');
                return;
            }
            
            if (!destinoData) {
                alert('Destino não definido');
                return;
            }
            
            // Usar posição atual como origem
            origemData = {
                lat: currentPosition.lat,
                lng: currentPosition.lng,
                endereco: 'Posição Atual'
            };
            
            document.getElementById('origemText').textContent = 'Posição Atual';
            
            if (originMarker) map.removeLayer(originMarker);
            originMarker = L.marker([currentPosition.lat, currentPosition.lng], {
                icon: L.divIcon({
                    className: 'origin-marker',
                    html: '<div style="width: 16px; height: 16px; background: #28a745; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>'
                })
            }).addTo(map);
            
            calcularRota();
        }

        function processarRotaOSRM(route) {
            const steps = route.legs[0].steps;
            const instrucoes = steps.map((step, index) => ({
                instrucao: step.maneuver.type === 'depart' ? 'Siga em frente' : 
                           step.maneuver.type === 'arrive' ? 'Você chegou ao destino' :
                           step.name || 'Continue',
                distancia: step.distance,
                duracao: step.duration,
                coordenadas: {
                    lat: step.maneuver.location[1],
                    lng: step.maneuver.location[0]
                }
            }));
            
            return {
                distance: route.distance,
                duration: route.duration,
                geometry: route.geometry,
                instrucoes: instrucoes
            };
        }

        function desenharRota(rota) {
            // Remover rota anterior
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            
            // Decodificar polyline
            const coordinates = decodePolyline(rota.geometry);
            const latLngs = coordinates.map(coord => [coord[1], coord[0]]);
            
            // Desenhar rota
            routePolyline = L.polyline(latLngs, {
                color: '#007bff',
                weight: 6,
                opacity: 0.7,
                lineJoin: 'round'
            }).addTo(map);
            
            // Ajustar visualização
            map.fitBounds(routePolyline.getBounds(), { padding: [50, 50] });
        }

        function decodePolyline(str, precision) {
            precision = precision || 5;
            var factor = Math.pow(10, precision);
            var coordinates = [];
            var index = 0, lat = 0, lng = 0;
            
            while (index < str.length) {
                var b, shift = 0, result = 0;
                do {
                    b = str.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                var dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lat += dlat;
                
                shift = 0;
                result = 0;
                do {
                    b = str.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                var dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lng += dlng;
                
                coordinates.push([lng / factor, lat / factor]);
            }
            
            return coordinates;
        }

        function processarRota() {
            if (rotaData && rotaData.instrucoes) {
                // Processar rota já existente do servidor
                console.log('Rota carregada com', rotaData.instrucoes.length, 'instruções');
            }
        }

        function mostrarBotaoRecalcular() {
            document.getElementById('btnRecalc').style.display = 'flex';
        }

        function esconderBotaoRecalcular() {
            document.getElementById('btnRecalc').style.display = 'none';
        }

        // Navigation Functions
        function toggleNavigation() {
            if (!rotaData) {
                alert('Calcule uma rota primeiro');
                return;
            }
            
            if (!isGPSActive) {
                alert('Ative o GPS primeiro');
                return;
            }
            
            if (isNavigating) {
                pararNavegacao();
            } else {
                iniciarNavegacao();
            }
        }

        function iniciarNavegacao() {
            isNavigating = true;
            document.getElementById('navPanel').classList.add('active');
            document.getElementById('btnNav').innerHTML = '<i class="fas fa-stop"></i>';
            
            if (rotaData && rotaData.instrucoes && rotaData.instrucoes.length > 0) {
                atualizarInstrucaoNavegacao(0);
            }
            
            // Centralizar no usuário
            if (currentPosition) {
                map.setView([currentPosition.lat, currentPosition.lng], 16);
            }
            
            console.log('Navegação iniciada');
        }

        function pararNavegacao() {
            isNavigating = false;
            document.getElementById('navPanel').classList.remove('active');
            document.getElementById('btnNav').innerHTML = '<i class="fas fa-play"></i>';
            
            console.log('Navegação parada');
        }

        function atualizarInstrucaoNavegacao(index) {
            if (!rotaData || !rotaData.instrucoes) return;
            
            const instrucao = rotaData.instrucoes[index];
            if (!instrucao) return;
            
            document.getElementById('navText').textContent = instrucao.instrucao;
            
            if (instrucao.distancia) {
                const dist = instrucao.distancia;
                if (dist < 1000) {
                    document.getElementById('navDistance').textContent = Math.round(dist) + 'm';
                } else {
                    document.getElementById('navDistance').textContent = (dist / 1000).toFixed(1) + 'km';
                }
            }
            
            // Atualizar estatísticas
            const distanciaRestante = rotaData.instrucoes.slice(index).reduce((sum, i) => sum + (i.distancia || 0), 0);
            const tempoRestante = rotaData.instrucoes.slice(index).reduce((sum, i) => sum + (i.duracao || 0), 0);
            
            document.getElementById('remainingDistance').textContent = (distanciaRestante / 1000).toFixed(1) + ' km';
            document.getElementById('remainingTime').textContent = Math.round(tempoRestante / 60) + ' min';
            
            // Calcular ETA
            const agora = new Date();
            const eta = new Date(agora.getTime() + tempoRestante * 1000);
            document.getElementById('etaTime').textContent = eta.getHours().toString().padStart(2, '0') + ':' + eta.getMinutes().toString().padStart(2, '0');
            
            // Sintetizar voz
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(instrucao.instrucao);
                utterance.lang = 'pt-BR';
                utterance.rate = 1.0;
                speechSynthesis.speak(utterance);
            }
        }

        function verificarProgresso(lat, lng) {
            if (!rotaData || !rotaData.instrucoes) return;
            
            // Calcular distância até o próximo ponto de instrução
            // (Implementação simplificada - em produção usar algoritmo mais robusto)
            
            let menorDistancia = Infinity;
            let indiceMaisProximo = 0;
            
            rotaData.instrucoes.forEach((instrucao, index) => {
                if (instrucao.coordenadas) {
                    const dist = calcularDistancia(
                        lat, lng, 
                        instrucao.coordenadas.lat, 
                        instrucao.coordenadas.lng
                    );
                    
                    if (dist < menorDistancia) {
                        menorDistancia = dist;
                        indiceMaisProximo = index;
                    }
                }
            });
            
            // Se chegou perto de um ponto de instrução (menos de 50m)
            if (menorDistancia < 0.05) { // aproximadamente 50m
                atualizarInstrucaoNavegacao(indiceMaisProximo);
                
                // Mostrar alerta se próximo (menos de 100m)
                if (menorDistancia < 0.1 && indiceMaisProximo < rotaData.instrucoes.length - 1) {
                    mostrarAlerta(rotaData.instrucoes[indiceMaisProximo].instrucao);
                }
            }
            
            // Verificar se chegou ao destino (menos de 20m)
            if (indiceMaisProximo === rotaData.instrucoes.length - 1 && menorDistancia < 0.02) {
                mostrarChegada();
            }
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function mostrarAlerta(mensagem) {
            const alertDiv = document.getElementById('maneuverAlert');
            document.getElementById('alertText').textContent = mensagem;
            alertDiv.classList.add('show');
            
            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 4000);
        }

        function mostrarChegada() {
            alert('🎉 Você chegou ao destino!');
            pararNavegacao();
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('Você chegou ao seu destino!');
                utterance.lang = 'pt-BR';
                speechSynthesis.speak(utterance);
            }
        }

        // Prevenir zoom do iOS em inputs
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('focus', function() {
                if (window.innerWidth < 768) {
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        document.body.scrollTop = 0;
                    }, 0);
                }
            });
        });

        // Prevenir comportamentos indesejados em mobile
        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('#map')) {
                // Permitir scroll no mapa
                return;
            }
        }, { passive: true });
    </script>
</body>
</html>