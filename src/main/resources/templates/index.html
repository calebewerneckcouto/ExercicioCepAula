<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Navega√ß√£o Mobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-rotate@0.2.8/dist/leaflet-rotate.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
        }
        
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        /* Painel de navega√ß√£o COMPACTO para mobile */
        .nav-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            padding: 10px;
            display: none;
        }
        
        .nav-panel.active {
            display: block;
        }
        
        .nav-instruction {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .nav-instruction .icon {
            font-size: 24px;
            color: #667eea;
            min-width: 28px;
        }
        
        .nav-instruction .text {
            flex: 1;
            font-size: 12px;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .nav-instruction .distance {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            min-width: 50px;
            text-align: right;
        }
        
        .nav-stats {
            display: flex;
            gap: 6px;
            justify-content: space-around;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 10px;
        }
        
        .nav-stats .stat {
            text-align: center;
            flex: 1;
        }
        
        .nav-stats .value {
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
        }
        
        .nav-stats .label {
            font-size: 9px;
            color: #666;
            margin-top: 2px;
        }
        
        /* Painel de busca */
        .search-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .search-header {
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-content {
            padding: 15px;
        }
        
        .quick-search {
            position: relative;
            margin-bottom: 10px;
        }
        
        .quick-search input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
        }
        
        .quick-search .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 18px;
        }
        
        .location-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .location-item .icon {
            font-size: 20px;
            min-width: 25px;
        }
        
        .location-item .text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .location-item .clear {
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
        }
        
        .search-results {
            max-height: 40vh;
            overflow-y: auto;
        }
        
        .result-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .result-item:hover {
            background: #f8f9fa;
        }
        
        .result-item .name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .result-item .address {
            font-size: 13px;
            color: #666;
        }
        
        /* Controles flutuantes */
        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        .control-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 64px;
            height: 64px;
        }
        
        /* Toggle de busca */
        .search-toggle {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 999;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            color: #667eea;
        }
        
        /* Veloc√≠metro */
        .speed-display {
            position: fixed;
            bottom: 20px;
            left: 15px;
            z-index: 1000;
            background: white;
            padding: 10px 16px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
        }
        
        .speed-display.active {
            display: block;
        }
        
        .speed-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .speed-unit {
            font-size: 12px;
            color: #666;
        }
        
        /* GPS Status */
        .gps-status {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 999;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 12px;
            font-weight: 600;
        }
        
        .gps-status.active {
            background: #28a745;
            color: white;
        }
        
        .gps-status.inactive {
            background: #dc3545;
            color: white;
        }
        
        /* B√∫ssola */
        .compass-indicator {
            position: fixed;
            top: 80px;
            right: 15px;
            z-index: 999;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .compass-indicator.active {
            display: flex;
        }
        
        .compass-needle {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 30px solid #dc3545;
            position: absolute;
            transition: transform 0.3s ease;
            transform-origin: center 20px;
        }
        
        .compass-label {
            position: absolute;
            font-size: 10px;
            font-weight: bold;
            color: #666;
        }
        
        /* Alerta de manobra */
        .maneuver-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
            max-width: 90%;
        }
        
        .maneuver-alert.show {
            display: block;
            animation: alertPulse 0.5s ease;
        }
        
        .maneuver-alert .icon {
            font-size: 64px;
            margin-bottom: 15px;
        }
        
        .maneuver-alert .text {
            font-size: 24px;
            font-weight: bold;
        }
        
        @keyframes alertPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        /* Bot√µes de a√ß√£o */
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .quick-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-clear {
            background: #dc3545;
            color: white;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .loading i {
            font-size: 32px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="gpsStatus" class="gps-status inactive">
        <i class="fas fa-satellite-dish"></i> GPS OFF
    </div>
    
    <!-- B√∫ssola -->
    <div id="compassIndicator" class="compass-indicator">
        <div class="compass-needle" id="compassNeedle"></div>
        <span class="compass-label" style="top: 5px;">N</span>
    </div>
    
    <div class="search-toggle" onclick="toggleSearchPanel()">
        <i class="fas fa-search"></i>
    </div>
    
    <div id="searchPanel" class="search-panel" style="display: none;">
        <div class="search-header">
            <h6 class="mb-0"><i class="fas fa-map-marker-alt"></i> Buscar Destino</h6>
            <i class="fas fa-times" onclick="toggleSearchPanel()" style="cursor: pointer;"></i>
        </div>
        <div class="search-content">
            <div class="quick-search">
                <input type="text" id="inputBusca" placeholder="Digite endere√ßo ou CEP..." autocomplete="off">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div class="location-item" id="destinoDisplay">
                <span class="icon">üèÅ</span>
                <span class="text" id="destinoText">Nenhum destino</span>
                <i class="fas fa-times-circle clear" onclick="clearDestino()" style="display: none;"></i>
            </div>
            
            <div id="searchResults" class="search-results"></div>
            
            <div class="quick-actions">
                <button class="btn-calculate" onclick="iniciarNavegacao()" id="btnCalcular" disabled>
                    <i class="fas fa-route"></i> Navegar
                </button>
                <button class="btn-clear" onclick="limparTudo()">
                    <i class="fas fa-trash"></i> Limpar
                </button>
            </div>
        </div>
    </div>
    
    <div id="navPanel" class="nav-panel">
        <div class="nav-instruction">
            <div class="icon" id="navIcon">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="text">
                <div id="navText">Iniciando navega√ß√£o...</div>
            </div>
            <div class="distance" id="navDistance">--</div>
        </div>
        <div class="nav-stats">
            <div class="stat">
                <div class="value" id="etaTime">--:--</div>
                <div class="label">Chegada</div>
            </div>
            <div class="stat">
                <div class="value" id="remainingDistance">--</div>
                <div class="label">Dist√¢ncia</div>
            </div>
            <div class="stat">
                <div class="value" id="remainingTime">--</div>
                <div class="label">Tempo</div>
            </div>
        </div>
    </div>
    
    <div id="speedDisplay" class="speed-display">
        <span class="speed-value" id="speedValue">0</span>
        <span class="speed-unit">km/h</span>
    </div>
    
    <div id="maneuverAlert" class="maneuver-alert">
        <div class="icon" id="alertIcon">
            <i class="fas fa-arrow-right"></i>
        </div>
        <div class="text" id="alertText">Vire √† direita</div>
    </div>
    
    <div class="floating-controls">
        <button class="control-btn primary" id="btnNav" onclick="toggleNavigation()" title="Navega√ß√£o">
            <i class="fas fa-play"></i>
        </button>
        <button class="control-btn" onclick="toggleRotacao()" id="btnRotacao" title="Rota√ß√£o 3D">
            <i class="fas fa-compass"></i>
        </button>
        <button class="control-btn" onclick="recalcularRota()" id="btnRecalc" title="Recalcular" style="display: none;">
            <i class="fas fa-redo"></i>
        </button>
        <button class="control-btn" onclick="centralizarUsuario()" title="Seguir Posi√ß√£o">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button class="control-btn" onclick="iniciarGPS()" id="btnGPS" title="GPS">
            <i class="fas fa-satellite"></i>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>
    
    <script>
        var map;
        var userMarker = null;
        var destinationMarker = null;
        var routePolyline = null;
        var watchId = null;
        var isGPSActive = false;
        var isNavigating = false;
        var destinoData = null;
        var rotaData = null;
        var currentPosition = null;
        var searchTimeout = null;
        var recalcularTimeout = null;
        var currentHeading = 0;
        var seguirUsuario = false;
        var modoRotacao = false;
        var autoFollow = true; // Nova vari√°vel para controle autom√°tico de foco

        window.onload = function() {
            inicializarMapa();
            configurarEventos();
            setTimeout(() => iniciarGPS(), 1000);
        };

        function inicializarMapa() {
            map = L.map('map', {
                zoomControl: false,
                rotate: true,
                rotateControl: false,
                bearing: 0,
                touchRotate: true,
                compassBearing: true
            }).setView([-15.7797, -47.9297], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            L.control.zoom({
                position: 'bottomleft'
            }).addTo(map);
            
            // Adicionar suporte a rota√ß√£o manual (dois dedos)
            map.on('rotate', function(e) {
                if (!modoRotacao) {
                    // Permitir rota√ß√£o manual mas n√£o for√ßar seguimento
                    console.log('Mapa rotacionado manualmente: ' + e.bearing + '¬∞');
                }
            });
        }

        function configurarEventos() {
            const input = document.getElementById('inputBusca');
            
            input.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                if (e.target.value.length >= 3) {
                    searchTimeout = setTimeout(() => {
                        buscarLocal(e.target.value);
                    }, 500);
                } else {
                    document.getElementById('searchResults').innerHTML = '';
                }
            });
        }

        function iniciarGPS() {
            if (!navigator.geolocation) {
                alert('GPS n√£o dispon√≠vel neste dispositivo');
                return;
            }

            if (isGPSActive) {
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                }
                isGPSActive = false;
                document.getElementById('gpsStatus').className = 'gps-status inactive';
                document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-satellite-dish"></i> GPS OFF';
                document.getElementById('speedDisplay').classList.remove('active');
            } else {
                watchId = navigator.geolocation.watchPosition(
                    atualizarPosicao,
                    erroGPS,
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
                
                isGPSActive = true;
                document.getElementById('gpsStatus').className = 'gps-status active';
                document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-satellite-dish"></i> GPS ON';
                document.getElementById('speedDisplay').classList.add('active');
            }
        }

        function atualizarPosicao(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const speed = (position.coords.speed || 0) * 3.6;
            
            currentPosition = { lat, lng };
            
            document.getElementById('speedValue').textContent = Math.round(speed);
            
            if (!userMarker) {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="width: 20px; height: 20px; background: #007bff; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20]
                    })
                }).addTo(map);
                
                // Centralizar no usu√°rio com zoom adequado
                map.setView([lat, lng], 16);
            } else {
                userMarker.setLatLng([lat, lng]);
                
                // Seguir automaticamente o usu√°rio se estiver navegando
                if (isNavigating && autoFollow) {
                    // Centralizar no usu√°rio mantendo o zoom atual
                    map.setView([lat, lng], map.getZoom());
                }
            }
            
            // RECALCULAR AUTOMATICAMENTE se navegando e passaram 30 segundos
            if (isNavigating && rotaData) {
                clearTimeout(recalcularTimeout);
                recalcularTimeout = setTimeout(() => {
                    recalcularRotaAutomatico();
                }, 30000); // 30 segundos
                
                verificarProgresso(lat, lng);
            }
        }

        function erroGPS(error) {
            console.error('Erro GPS:', error);
            document.getElementById('gpsStatus').className = 'gps-status inactive';
            document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro GPS';
        }

        function centralizarUsuario() {
            if (currentPosition) {
                autoFollow = !autoFollow;
                
                const btn = document.querySelector('[onclick="centralizarUsuario()"]');
                if (autoFollow) {
                    btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    btn.style.color = 'white';
                    map.setView([currentPosition.lat, currentPosition.lng], 17);
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                    // N√£o altera a visualiza√ß√£o quando desativado
                }
            } else {
                alert('GPS n√£o est√° ativo');
            }
        }
        
        function toggleRotacao() {
            modoRotacao = !modoRotacao;
            
            const btn = document.getElementById('btnRotacao');
            const compass = document.getElementById('compassIndicator');
            
            if (modoRotacao) {
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                btn.style.color = 'white';
                autoFollow = true;
                compass.classList.add('active');
                
                // Ativar rota√ß√£o
                if (currentHeading !== null) {
                    map.setBearing(-currentHeading);
                    updateCompassNeedle(currentHeading);
                }
                
                // Ativar seguimento da c√¢mera
                const btnSeguir = document.querySelector('[onclick="centralizarUsuario()"]');
                btnSeguir.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                btnSeguir.style.color = 'white';
            } else {
                btn.style.background = 'white';
                btn.style.color = '#333';
                compass.classList.remove('active');
                
                // Resetar rota√ß√£o
                map.setBearing(0);
            }
        }
        
        function updateCompassNeedle(heading) {
            const needle = document.getElementById('compassNeedle');
            if (needle && heading !== null) {
                needle.style.transform = `rotate(${heading}deg)`;
            }
        }

        function toggleSearchPanel() {
            const panel = document.getElementById('searchPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function buscarLocal(query) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query || query.length < 3) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i></div>';
            
            // Buscar no Nominatim
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=8&countrycodes=br`)
                .then(response => response.json())
                .then(data => {
                    mostrarResultados(data);
                })
                .catch(error => {
                    console.error('Erro na busca:', error);
                    resultsDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #dc3545;">Erro na busca</div>';
                });
        }

        function mostrarResultados(resultados) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (resultados.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">Nenhum resultado</div>';
                return;
            }
            
            let html = '';
            resultados.forEach(r => {
                html += `
                    <div class="result-item" onclick='selecionarDestino(${r.lat}, ${r.lon}, "${r.display_name.replace(/'/g, "\\'")}");'>
                        <div class="name">${r.display_name.split(',')[0]}</div>
                        <div class="address">${r.display_name}</div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        function selecionarDestino(lat, lng, endereco) {
            destinoData = {
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                endereco: endereco
            };
            
            document.getElementById('destinoText').textContent = endereco.split(',')[0];
            document.querySelector('#destinoDisplay .clear').style.display = 'block';
            
            if (destinationMarker) map.removeLayer(destinationMarker);
            destinationMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                })
            }).addTo(map);
            
            // Centralizar no destino com zoom adequado
            map.setView([lat, lng], 15);
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('inputBusca').value = '';
            document.getElementById('btnCalcular').disabled = false;
        }

        function clearDestino() {
            destinoData = null;
            document.getElementById('destinoText').textContent = 'Nenhum destino';
            document.querySelector('#destinoDisplay .clear').style.display = 'none';
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            document.getElementById('btnCalcular').disabled = true;
        }

        function limparTudo() {
            clearDestino();
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            rotaData = null;
            pararNavegacao();
            document.getElementById('btnRecalc').style.display = 'none';
            
            // Voltar para a posi√ß√£o do usu√°rio se dispon√≠vel
            if (currentPosition) {
                map.setView([currentPosition.lat, currentPosition.lng], 16);
            }
        }

        function iniciarNavegacao() {
            if (!currentPosition) {
                alert('Aguarde o GPS se conectar');
                return;
            }
            
            if (!destinoData) {
                alert('Selecione um destino');
                return;
            }
            
            calcularRota();
        }

        function calcularRota() {
            if (!currentPosition || !destinoData) return;
            
            const btn = document.getElementById('btnCalcular');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
            
            const url = `https://router.project-osrm.org/route/v1/driving/${currentPosition.lng},${currentPosition.lat};${destinoData.lng},${destinoData.lat}?overview=full&steps=true&geometries=polyline`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'Ok' && data.routes.length > 0) {
                        rotaData = processarRotaOSRM(data.routes[0]);
                        desenharRota(rotaData);
                        toggleSearchPanel();
                        document.getElementById('btnRecalc').style.display = 'flex';
                        
                        // Iniciar navega√ß√£o automaticamente
                        isNavigating = true;
                        document.getElementById('navPanel').classList.add('active');
                        document.getElementById('btnNav').innerHTML = '<i class="fas fa-stop"></i>';
                        
                        if (rotaData && rotaData.instrucoes && rotaData.instrucoes.length > 0) {
                            atualizarInstrucaoNavegacao(0);
                        }
                        
                        // Ativar seguimento autom√°tico
                        autoFollow = true;
                        const btnSeguir = document.querySelector('[onclick="centralizarUsuario()"]');
                        btnSeguir.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        btnSeguir.style.color = 'white';
                    } else {
                        alert('N√£o foi poss√≠vel calcular a rota');
                    }
                    
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-route"></i> Navegar';
                })
                .catch(error => {
                    console.error('Erro ao calcular rota:', error);
                    alert('Erro ao calcular rota. Tente novamente.');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-route"></i> Navegar';
                });
        }

        function recalcularRotaAutomatico() {
            if (!currentPosition || !destinoData) return;
            
            console.log('üîÑ Recalculando rota automaticamente...');
            
            const url = `https://router.project-osrm.org/route/v1/driving/${currentPosition.lng},${currentPosition.lat};${destinoData.lng},${destinoData.lat}?overview=full&steps=true&geometries=polyline`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'Ok' && data.routes.length > 0) {
                        rotaData = processarRotaOSRM(data.routes[0]);
                        desenharRota(rotaData);
                        console.log('‚úì Rota recalculada');
                    }
                })
                .catch(error => {
                    console.error('Erro ao recalcular:', error);
                });
        }

        function recalcularRota() {
            recalcularRotaAutomatico();
        }

        function processarRotaOSRM(route) {
            const steps = route.legs[0].steps;
            const instrucoes = steps.map((step, index) => ({
                instrucao: step.maneuver.type === 'depart' ? 'Siga em frente' : 
                           step.maneuver.type === 'arrive' ? 'Voc√™ chegou ao destino' :
                           step.name || 'Continue',
                distancia: step.distance,
                duracao: step.duration,
                coordenadas: {
                    lat: step.maneuver.location[1],
                    lng: step.maneuver.location[0]
                }
            }));
            
            return {
                distance: route.distance,
                duration: route.duration,
                geometry: route.geometry,
                instrucoes: instrucoes
            };
        }

        function desenharRota(rota) {
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            
            const coordinates = decodePolyline(rota.geometry);
            const latLngs = coordinates.map(coord => [coord[1], coord[0]]);
            
            routePolyline = L.polyline(latLngs, {
                color: '#007bff',
                weight: 6,
                opacity: 0.7,
                lineJoin: 'round'
            }).addTo(map);
            
            // Ajustar o zoom para mostrar toda a rota, mas com foco no ponto azul
            const bounds = routePolyline.getBounds();
            
            // Expandir os limites para incluir o usu√°rio e destino com margem
            if (userMarker) {
                bounds.extend(userMarker.getLatLng());
            }
            if (destinationMarker) {
                bounds.extend(destinationMarker.getLatLng());
            }
            
            // Ajustar o mapa para mostrar toda a rota com uma margem
            map.fitBounds(bounds, { 
                padding: [50, 50],
                maxZoom: 16 // Limitar o zoom m√°ximo para n√£o ficar muito distante
            });
        }

        function decodePolyline(str, precision) {
            precision = precision || 5;
            var factor = Math.pow(10, precision);
            var coordinates = [];
            var index = 0, lat = 0, lng = 0;
            
            while (index < str.length) {
                var b, shift = 0, result = 0;
                do {
                    b = str.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                var dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lat += dlat;
                
                shift = 0;
                result = 0;
                do {
                    b = str.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                var dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lng += dlng;
                
                coordinates.push([lng / factor, lat / factor]);
            }
            
            return coordinates;
        }

        function toggleNavigation() {
            if (!rotaData) {
                alert('Calcule uma rota primeiro');
                return;
            }
            
            if (!isGPSActive) {
                alert('Ative o GPS primeiro');
                return;
            }
            
            if (isNavigating) {
                pararNavegacao();
            } else {
                isNavigating = true;
                document.getElementById('navPanel').classList.add('active');
                document.getElementById('btnNav').innerHTML = '<i class="fas fa-stop"></i>';
                
                if (rotaData && rotaData.instrucoes && rotaData.instrucoes.length > 0) {
                    atualizarInstrucaoNavegacao(0);
                }
                
                // Centralizar no usu√°rio quando iniciar navega√ß√£o
                if (currentPosition) {
                    map.setView([currentPosition.lat, currentPosition.lng], 16);
                }
                
                // Ativar seguimento autom√°tico
                autoFollow = true;
                const btnSeguir = document.querySelector('[onclick="centralizarUsuario()"]');
                btnSeguir.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                btnSeguir.style.color = 'white';
            }
        }

        function pararNavegacao() {
            isNavigating = false;
            document.getElementById('navPanel').classList.remove('active');
            document.getElementById('btnNav').innerHTML = '<i class="fas fa-play"></i>';
            
            // Desativar seguimento autom√°tico
            autoFollow = false;
            const btnSeguir = document.querySelector('[onclick="centralizarUsuario()"]');
            btnSeguir.style.background = 'white';
            btnSeguir.style.color = '#333';
        }

        var currentInstructionIndex = 0;

        function atualizarInstrucaoNavegacao(index) {
            if (!rotaData || !rotaData.instrucoes) return;
            
            currentInstructionIndex = index;
            const instrucao = rotaData.instrucoes[index];
            if (!instrucao) return;
            
            document.getElementById('navText').textContent = instrucao.instrucao;
            
            if (instrucao.distancia) {
                const dist = instrucao.distancia;
                if (dist < 1000) {
                    document.getElementById('navDistance').textContent = Math.round(dist) + 'm';
                } else {
                    document.getElementById('navDistance').textContent = (dist / 1000).toFixed(1) + 'km';
                }
            }
            
            // Atualizar estat√≠sticas
            const distanciaRestante = rotaData.instrucoes.slice(index).reduce((sum, i) => sum + (i.distancia || 0), 0);
            const tempoRestante = rotaData.instrucoes.slice(index).reduce((sum, i) => sum + (i.duracao || 0), 0);
            
            document.getElementById('remainingDistance').textContent = (distanciaRestante / 1000).toFixed(1) + ' km';
            document.getElementById('remainingTime').textContent = Math.round(tempoRestante / 60) + ' min';
            
            // Calcular ETA
            const agora = new Date();
            const eta = new Date(agora.getTime() + tempoRestante * 1000);
            document.getElementById('etaTime').textContent = eta.getHours().toString().padStart(2, '0') + ':' + eta.getMinutes().toString().padStart(2, '0');
            
            // Sintetizar voz
            if ('speechSynthesis' in window && index === 0) {
                const utterance = new SpeechSynthesisUtterance(instrucao.instrucao);
                utterance.lang = 'pt-BR';
                utterance.rate = 1.0;
                speechSynthesis.speak(utterance);
            }
        }

        function verificarProgresso(lat, lng) {
            if (!rotaData || !rotaData.instrucoes) return;
            
            let menorDistancia = Infinity;
            let indiceMaisProximo = currentInstructionIndex;
            
            // Verificar apenas instru√ß√µes √† frente
            for (let i = currentInstructionIndex; i < rotaData.instrucoes.length; i++) {
                const instrucao = rotaData.instrucoes[i];
                if (instrucao.coordenadas) {
                    const dist = calcularDistancia(
                        lat, lng, 
                        instrucao.coordenadas.lat, 
                        instrucao.coordenadas.lng
                    );
                    
                    if (dist < menorDistancia) {
                        menorDistancia = dist;
                        indiceMaisProximo = i;
                    }
                }
            }
            
            // Avan√ßar instru√ß√£o automaticamente (50m)
            if (indiceMaisProximo > currentInstructionIndex && menorDistancia < 0.05) {
                atualizarInstrucaoNavegacao(indiceMaisProximo);
                
                // Falar nova instru√ß√£o
                if ('speechSynthesis' in window) {
                    const instrucao = rotaData.instrucoes[indiceMaisProximo];
                    const utterance = new SpeechSynthesisUtterance(instrucao.instrucao);
                    utterance.lang = 'pt-BR';
                    utterance.rate = 1.0;
                    speechSynthesis.speak(utterance);
                }
            }
            
            // Alerta de proximidade (100m)
            if (menorDistancia < 0.1 && menorDistancia > 0.05 && indiceMaisProximo < rotaData.instrucoes.length - 1) {
                const proxInstrucao = rotaData.instrucoes[indiceMaisProximo + 1];
                if (proxInstrucao) {
                    mostrarAlerta('Em ' + Math.round(menorDistancia * 1000) + 'm: ' + proxInstrucao.instrucao);
                }
            }
            
            // Verificar chegada ao destino
            if (indiceMaisProximo === rotaData.instrucoes.length - 1 && menorDistancia < 0.02) {
                mostrarChegada();
            }
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function mostrarAlerta(mensagem) {
            const alertDiv = document.getElementById('maneuverAlert');
            document.getElementById('alertText').textContent = mensagem;
            alertDiv.classList.add('show');
            
            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 4000);
        }

        function mostrarChegada() {
            alert('üéâ Voc√™ chegou ao destino!');
            pararNavegacao();
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('Voc√™ chegou ao seu destino!');
                utterance.lang = 'pt-BR';
                speechSynthesis.speak(utterance);
            }
        }
    </script>
</body>
</html>